<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoneTraveler - Suivez les pierres</title>
    
    <!-- Outils (CDN pour fonctionnement statique) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* Styles personnalis√©s */
        #map { height: 350px; width: 100%; border-radius: 0.5rem; z-index: 0;}
        #map-step, #map-create { height: 200px; width: 100%; border-radius: 0.5rem; z-index: 0; }
        .stone-card:hover { transform: translateY(-2px); transition: all 0.2s; }
        .like-anim { animation: beat 0.3s; }
        @keyframes beat { 0%{transform: scale(1);} 50%{transform: scale(1.3);} 100%{transform: scale(1);} }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Styles responsive pour mobile */
        @media (max-width: 768px) {
            body, #page-home {
                overflow-y: auto !important;
                height: auto !important;
            }
            
            #page-home {
                height: auto !important;
                min-height: 100vh;
                overflow: visible !important;
            }
            
            #page-home .grid {
                grid-template-columns: 1fr !important;
                height: auto !important;
                gap: 1rem !important;
                overflow: visible !important;
            }
            
            .overflow-hidden {
                overflow: visible !important;
            }
            
            #rocks-list {
                max-height: none !important;
                min-height: auto !important;
                overflow: visible !important;
            }
            
            .mobile-hidden {
                display: none !important;
            }
            
            .mobile-full {
                width: 100% !important;
            }
            
            .mobile-stack {
                flex-direction: column !important;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem !important;
            }
            
            .mobile-p-2 {
                padding: 0.5rem !important;
            }
            
            #map, #map-step, #map-create {
                height: 250px !important;
            }
            
            .mobile-only {
                display: block !important;
            }
            
            .desktop-only {
                display: none !important;
            }
        }

        @media (min-width: 769px) {
            .mobile-only {
                display: none !important;
            }
            
            .desktop-only {
                display: block !important;
            }
        }

        /* Styles pour l'upload de photos */
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #10b981;
            background-color: #f0fdf4;
        }

        .upload-area.dragover {
            border-color: #10b981;
            background-color: #f0fdf4;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }

        .upload-progress {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .upload-progress-bar {
            height: 100%;
            background: #10b981;
            transition: width 0.3s;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans flex flex-col">

    <!-- 1. NAVIGATION -->
    <nav class="bg-white shadow-md z-50 shrink-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center cursor-pointer" onclick="app.showPage('home')">
                    <i class="fa-solid fa-shapes text-emerald-600 text-2xl mr-2"></i>
                    <span class="font-bold text-xl tracking-tight mobile-text-sm">StoneTraveler</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="app.showPage('ranking')" class="text-gray-600 hover:text-emerald-600 hidden sm:block mobile-hidden"><i class="fa-solid fa-trophy mr-1"></i>Classement</button>
                    <div id="nav-buttons" class="flex items-center gap-3"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 2. CONTENU PRINCIPAL -->
    <div class="flex-1">

        <!-- PAGE: ACCUEIL -->
        <div id="page-home" class="flex flex-col max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6 pb-2 fade-in">
            <!-- Barre de recherche et boutons -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-4 flex flex-col sm:flex-row gap-3 shrink-0 items-center mobile-stack mobile-p-2">
                <div class="relative flex-1 w-full">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="search-input" onkeyup="app.handleSearch()" placeholder="Rechercher..." class="w-full border border-gray-300 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 mobile-text-sm">
                </div>
                <div class="flex gap-2 w-full sm:w-auto mobile-full mobile-stack">
                    <button onclick="app.openModal('create')" class="flex-1 sm:flex-none bg-emerald-600 text-white px-4 py-2 rounded-md hover:bg-emerald-700 text-sm font-bold mobile-text-sm mobile-full"><i class="fa-solid fa-plus circle mr-1"></i> Cr√©er</button>
                    <button onclick="app.openModal('step')" class="flex-1 sm:flex-none bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 text-sm font-bold mobile-text-sm mobile-full"><i class="fa-solid fa-location-dot mr-1"></i> J'ai trouv√© !</button>
                </div>
            </div>

            <!-- Contenu principal -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 pb-4">
                <!-- Liste des pierres -->
                <div class="lg:col-span-4 flex flex-col">
                    <div class="flex justify-between items-end mb-2 px-1">
                        <h3 class="font-bold text-gray-700 mobile-text-sm">Derni√®res Publications</h3>
                    </div>
                    <div class="space-y-3" id="rocks-list"></div>
                </div>

                <!-- D√©tails de la pierre -->
                <div class="lg:col-span-8 bg-white rounded-lg shadow-lg border border-gray-200 flex flex-col mobile-full" id="rock-details-panel">
                    <!-- √âtat vide -->
                    <div id="empty-state" class="flex flex-col items-center justify-center text-gray-400 p-8 text-center">
                        <div class="bg-emerald-50 p-6 rounded-full mb-4">
                            <i class="fa-solid fa-map-location-dot text-6xl text-emerald-200 mobile-text-sm"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-600 mobile-text-sm">Explorez le monde des pierres</h3>
                        <p class="text-sm mt-2 text-gray-500 mobile-text-sm">S√©lectionnez une pierre pour voir ses d√©tails</p>
                    </div>
                    
                    <!-- Contenu des d√©tails -->
                    <div id="details-content" class="hidden flex-col">
                        <!-- Header avec bouton retour mobile -->
                        <div class="p-6 border-b bg-white z-10 shadow-sm mobile-p-2">
                            <div class="flex justify-between items-start mobile-stack">
                                <div class="mobile-full">
                                    <div class="mobile-only flex items-center gap-2 mb-3">
                                        <button onclick="app.showRockList()" class="text-emerald-600 hover:text-emerald-800 flex items-center gap-2 mobile-text-sm">
                                            <i class="fa-solid fa-arrow-left"></i>
                                            Retour √† la liste
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-2 mb-1 mobile-stack">
                                        <h2 class="text-2xl font-bold text-gray-800 mobile-text-sm" id="detail-name">Nom</h2>
                                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded border font-mono mobile-text-sm" id="detail-code">CODE</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mobile-text-sm">Par <span id="detail-author" class="font-medium text-emerald-600">Auteur</span> ‚Ä¢ <span id="detail-date">Date</span></p>
                                </div>
                                <div class="flex flex-col items-end desktop-only">
                                    <button onclick="app.toggleLike()" class="text-gray-400 hover:text-red-500 transition transform active:scale-125 group" id="like-btn">
                                        <i class="fa-solid fa-heart text-2xl group-hover:scale-110 transition"></i>
                                    </button>
                                    <span class="text-sm font-bold text-gray-600" id="detail-likes">0</span>
                                </div>
                            </div>
                            <div class="flex gap-4 mt-4 text-sm mobile-stack mobile-text-sm">
                                <div class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full flex items-center gap-2 mobile-full mobile-text-sm">
                                    <i class="fa-solid fa-road"></i> <span id="detail-km" class="font-bold">0</span> km
                                </div>
                                <div class="bg-purple-50 text-purple-700 px-3 py-1 rounded-full flex items-center gap-2 mobile-full mobile-text-sm">
                                    <i class="fa-solid fa-flag"></i> <span id="detail-borders" class="font-bold">0</span> fronti√®res
                                </div>
                                <div id="edit-rock-buttons" class="hidden gap-2 mobile-stack">
                                    <button onclick="app.editRock()" class="bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600 text-xs font-medium mobile-full mobile-text-sm">
                                        <i class="fa-solid fa-pen mr-1"></i>Modifier
                                    </button>
                                    <button onclick="app.deleteRock()" class="bg-red-500 text-white px-3 py-1 rounded-full hover:bg-red-600 text-xs font-medium mobile-full mobile-text-sm">
                                        <i class="fa-solid fa-trash mr-1"></i>Supprimer
                                    </button>
                                </div>
                            </div>
                            <!-- Bouton like pour mobile -->
                            <div class="mobile-only flex justify-center mt-4">
                                <button onclick="app.toggleLike()" class="flex items-center gap-2 text-gray-400 hover:text-red-500 transition" id="like-btn-mobile">
                                    <i class="fa-solid fa-heart text-xl"></i>
                                    <span class="text-sm font-bold text-gray-600" id="detail-likes-mobile">0</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Contenu d√©filable -->
                        <div class="flex-1">
                            <div class="p-6 space-y-6 mobile-p-2">
                                <!-- Carousel d'images -->
                                <div class="relative w-full h-72 bg-gray-100 rounded-xl overflow-hidden group shadow-inner">
                                    <img id="carousel-img" src="" class="w-full h-full object-cover transition-opacity duration-300">
                                    <div class="absolute inset-0 flex items-center justify-between px-4 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                        <button onclick="app.moveCarousel(-1)" class="pointer-events-auto bg-black/50 text-white w-10 h-10 flex items-center justify-center rounded-full hover:bg-black/70 transition">
                                            <i class="fa-solid fa-chevron-left"></i>
                                        </button>
                                        <button onclick="app.moveCarousel(1)" class="pointer-events-auto bg-black/50 text-white w-10 h-10 flex items-center justify-center rounded-full hover:bg-black/70 transition">
                                            <i class="fa-solid fa-chevron-right"></i>
                                        </button>
                                    </div>
                                    <div class="absolute bottom-3 right-3 bg-black/60 text-white text-xs px-3 py-1 rounded-full backdrop-blur-sm">
                                        <span id="carousel-counter">1/1</span>
                                    </div>
                                </div>
                                
                                <!-- Description -->
                                <div class="bg-emerald-50/50 p-5 rounded-xl border border-emerald-100 mobile-p-2">
                                    <h3 class="font-bold text-emerald-800 mb-2 text-sm uppercase tracking-wide">L'Histoire</h3>
                                    <p class="text-gray-700 text-sm leading-relaxed italic mobile-text-sm" id="detail-desc">Description...</p>
                                </div>
                                
                                <!-- Carte -->
                                <div>
                                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2 mobile-text-sm">
                                        <i class="fa-solid fa-map-marked-alt text-emerald-600"></i> Le Voyage
                                    </h3>
                                    <div id="map" class="shadow-md border border-gray-200"></div>
                                </div>
                                
                                <!-- Commentaires -->
                                <div class="border-t pt-6 mobile-p-2">
                                    <h3 class="font-bold text-gray-800 mb-4 mobile-text-sm">
                                        Commentaires (<span id="comments-count">0</span>)
                                    </h3>
                                    <div id="comments-list" class="space-y-4 mb-6"></div>
                                    <div id="comment-form-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE: CLASSEMENT -->
        <div id="page-ranking" class="hidden max-w-4xl mx-auto w-full px-4 sm:px-6 lg:px-8 pt-6 pb-10 fade-in">
             <h2 class="text-3xl font-bold mb-6 text-center text-emerald-800 mobile-text-sm">üèÜ Tableau des Leaders</h2>
            <div class="flex justify-center gap-4 mb-6 mobile-stack">
                <button onclick="app.renderRanking('likes')" class="px-4 py-2 rounded-full bg-white border shadow-sm hover:bg-emerald-50 focus:ring-2 focus:ring-emerald-500 font-medium text-sm active-filter mobile-full mobile-text-sm"><i class="fa-solid fa-heart text-red-500 mr-1"></i> Likes</button>
                <button onclick="app.renderRanking('km')" class="px-4 py-2 rounded-full bg-white border shadow-sm hover:bg-emerald-50 focus:ring-2 focus:ring-emerald-500 font-medium text-sm mobile-full mobile-text-sm"><i class="fa-solid fa-road text-blue-500 mr-1"></i> Distance</button>
            </div>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase mobile-text-sm">Rang</th><th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase mobile-text-sm">Pierre</th><th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase mobile-text-sm">Stats</th><th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase mobile-text-sm">Action</th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="ranking-list"></tbody>
                </table>
            </div>
        </div>

        <!-- PAGE: LOGIN / SIGNUP -->
        <div id="page-auth" class="hidden flex items-center justify-center bg-gray-100 fade-in">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-md w-full border-t-4 border-emerald-500 mobile-p-2">
                <div id="auth-login">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800 mobile-text-sm">Connexion</h2>
                    <form onsubmit="app.handleLogin(event)">
                        <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2 mobile-text-sm">Email</label><input id="login-email" type="email" required class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-emerald-500 mobile-text-sm"></div>
                        <div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2 mobile-text-sm">Mdp</label><input id="login-password" type="password" required class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-emerald-500 mobile-text-sm"></div>
                        <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition mobile-text-sm">Se connecter</button>
                    </form>

                    <div class="mt-4 flex gap-2 mobile-stack">
                        <button onclick="app.signInWithGoogle()" class="flex-1 bg-white border py-2 rounded shadow-sm hover:bg-gray-50 mobile-text-sm"><i class="fa-brands fa-google mr-2"></i>Google</button>
                        <button onclick="app.signInAnonymously()" class="flex-1 bg-gray-100 py-2 rounded shadow-sm hover:bg-gray-200 mobile-text-sm">Anonyme</button>
                    </div>

                    <p class="mt-6 text-center text-sm text-gray-500 mobile-text-sm">Pas de compte ? <span onclick="app.toggleAuthMode('signup')" class="text-emerald-600 font-bold cursor-pointer hover:underline">Cr√©er un compte</span></p>
                </div>
                <div id="auth-signup" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800 mobile-text-sm">Inscription</h2>
                    <form onsubmit="app.handleSignup(event)">
                        <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2 mobile-text-sm">Pseudo</label><input id="signup-name" type="text" required class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-emerald-500 mobile-text-sm"></div>
                        <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2 mobile-text-sm">Email</label><input id="signup-email" type="email" required class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-emerald-500 mobile-text-sm"></div>
                        <div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2 mobile-text-sm">Mdp</label><input id="signup-password" type="password" required class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-emerald-500 mobile-text-sm"></div>
                        <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition mobile-text-sm">S'inscrire</button>
                    </form>
                    <p class="mt-6 text-center text-sm text-gray-500 mobile-text-sm">D√©j√† un compte ? <span onclick="app.toggleAuthMode('login')" class="text-emerald-600 font-bold cursor-pointer hover:underline">Se connecter</span></p>
                </div>
                <p class="mt-4 text-center text-xs text-gray-400 cursor-pointer hover:text-gray-600 mobile-text-sm" onclick="app.showPage('home')">‚Üê Retour</p>
            </div>
        </div>

        <!-- PAGE: PROFIL -->
        <div id="page-profile" class="hidden flex items-center justify-center bg-gray-50 fade-in">
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg w-full mobile-p-2">
                <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800 mobile-text-sm">Mon Profil</h2><button onclick="app.showPage('home')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button></div>
                <form onsubmit="app.handleUpdateProfile(event)">
                    <div class="flex flex-col items-center mb-6">
                        <div class="relative w-24 h-24 mb-4 group cursor-pointer">
                            <img id="profile-preview-img" src="" class="w-full h-full rounded-full object-cover border-4 border-emerald-100 shadow-md">
                            <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white text-xs font-bold">Changer</div>
                        </div>
                        <input id="edit-avatar" type="text" class="w-full text-xs text-gray-400 border p-1 rounded text-center mb-2 mobile-text-sm" placeholder="URL de l'avatar" onchange="document.getElementById('profile-preview-img').src = this.value">
                    </div>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold text-gray-700 mb-1 mobile-text-sm">Pseudo</label><input id="edit-name" type="text" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none mobile-text-sm"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1 mobile-text-sm">Bio</label><textarea id="edit-bio" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none mobile-text-sm"></textarea></div>
                    </div>
                    <button type="submit" class="w-full mt-6 bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 shadow-md transition mobile-text-sm">Sauvegarder</button>
                </form>
            </div>
        </div>

    </div>

    <!-- MODAL: CREATE -->
    <div id="modal-create" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60] backdrop-blur-sm">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full m-4 shadow-2xl animate-fade-in relative mobile-p-2 max-h-[90vh] overflow-y-auto">
            <button onclick="app.closeModal('create')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            <h2 class="text-2xl font-bold mb-1 text-emerald-800 mobile-text-sm">Cr√©er une Pierre</h2>
            <form onsubmit="app.handleCreateStone(event)" class="space-y-4 mt-4">
                <input id="create-name-input" type="text" required placeholder="Nom de la pierre" class="w-full border p-2 rounded-lg mobile-text-sm">
                <textarea id="create-desc-input" rows="3" required placeholder="Histoire..." class="w-full border p-2 rounded-lg mobile-text-sm"></textarea>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1 mobile-text-sm">Point de d√©part</label>
                    <div class="relative">
                        <div id="map-create" class="border border-gray-300 overflow-hidden h-48 rounded-lg z-0"></div>
                        <button type="button" onclick="app.locateUser('create')" class="absolute bottom-2 right-2 bg-white p-2 rounded shadow-md hover:bg-gray-100 text-gray-600 z-[400]" title="Me localiser"><i class="fa-solid fa-crosshairs"></i></button>
                    </div>
                    <div class="relative mt-2">
                         <input type="text" id="create-location-name" readonly required placeholder="Cliquez sur la carte" class="w-full border p-2 rounded-lg bg-gray-50 text-sm text-gray-600 mobile-text-sm">
                         <div id="geo-loading-create" class="absolute right-3 top-2 text-xs text-gray-400 hidden loading-dots">Recherche</div>
                    </div>
                    <input type="hidden" id="create-lat"><input type="hidden" id="create-lng">
                </div>
                
                <!-- UPLOAD DE PHOTO -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1 mobile-text-sm">Photo</label>
                    <div class="upload-area" onclick="document.getElementById('file-input').click()" id="upload-area">
                        <i class="fa-solid fa-cloud-arrow-up text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mobile-text-sm">Cliquez pour s√©lectionner une image</p>
                        <p class="text-gray-400 text-xs mt-1">ou glissez-d√©posez ici</p>
                        <input type="file" id="file-input" accept="image/*" class="hidden" onchange="app.handleImageUpload(event)">
                    </div>
                    <div id="image-preview-container" class="hidden mt-3">
                        <img id="image-preview" class="image-preview">
                        <div class="upload-progress hidden" id="upload-progress">
                            <div class="upload-progress-bar" id="upload-progress-bar"></div>
                        </div>
                        <button type="button" onclick="app.removeImage()" class="mt-2 text-red-500 hover:text-red-700 text-sm">
                            <i class="fa-solid fa-trash mr-1"></i>Supprimer l'image
                        </button>
                    </div>
                    <input type="hidden" id="create-img-input">
                </div>
                
                <div class="pt-4 flex justify-end gap-3 mobile-stack">
                    <button type="button" onclick="app.closeModal('create')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg mobile-full mobile-text-sm">Annuler</button>
                    <button type="submit" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-bold mobile-full mobile-text-sm">Cr√©er</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: EDIT ROCK -->
    <div id="modal-edit-rock" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60] backdrop-blur-sm">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full m-4 shadow-2xl animate-fade-in relative mobile-p-2">
            <button onclick="app.closeModal('edit-rock')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            <h2 class="text-2xl font-bold mb-1 text-blue-800 mobile-text-sm">Modifier la Pierre</h2>
            <form onsubmit="app.handleEditRock(event)" class="space-y-4 mt-4">
                <input id="edit-rock-name-input" type="text" required placeholder="Nom de la pierre" class="w-full border p-2 rounded-lg mobile-text-sm">
                <textarea id="edit-rock-desc-input" rows="3" required placeholder="Histoire..." class="w-full border p-2 rounded-lg mobile-text-sm"></textarea>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1 mobile-text-sm">Photo</label>
                    <input id="edit-rock-img-input" type="text" placeholder="URL de l'image" class="w-full border p-2 rounded-lg mobile-text-sm">
                </div>
                <div class="pt-4 flex justify-end gap-3 mobile-stack">
                    <button type="button" onclick="app.closeModal('edit-rock')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg mobile-full mobile-text-sm">Annuler</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold mobile-full mobile-text-sm">Modifier</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: STEP -->
    <div id="modal-step" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60] backdrop-blur-sm">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full m-4 shadow-2xl animate-fade-in relative mobile-p-2">
            <button onclick="app.closeModal('step')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            <h2 class="text-2xl font-bold mb-1 text-orange-600 mobile-text-sm">J'ai trouv√© une pierre !</h2>
            <form id="form-step" onsubmit="app.handleStep(event)" class="space-y-4 mt-4">
                <input id="step-code-input" type="text" required placeholder="Code Unique (Ex: ST-001)" class="w-full border p-2 rounded-lg bg-gray-50 font-mono mobile-text-sm">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1 mobile-text-sm">Localisation</label>
                    <div id="map-step" class="border border-gray-300 overflow-hidden h-48 rounded-lg"></div>
                    <div class="relative mt-2">
                        <input type="text" id="step-location-name" readonly required placeholder="Cliquez sur la carte" class="w-full border p-2 rounded-lg bg-gray-50 text-sm text-gray-600 mobile-text-sm">
                        <div id="geo-loading" class="absolute right-3 top-2 text-xs text-gray-400 hidden loading-dots">Recherche</div>
                    </div>
                    <input type="hidden" id="step-lat"><input type="hidden" id="step-lng">
                    <input type="hidden" id="step-country">
                </div>
                <textarea id="step-message-input" rows="2" placeholder="Message..." class="w-full border p-2 rounded-lg mobile-text-sm"></textarea>
                <div class="pt-4 flex justify-end gap-3 mobile-stack">
                    <button type="button" onclick="app.closeModal('step')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg mobile-full mobile-text-sm">Annuler</button>
                    <button type="submit" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-bold mobile-full mobile-text-sm">Valider</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

    <script>
    // Configuration Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDOPfGOHYJ4Li4W_atXc5Jey_OEgz5_mTA",
        authDomain: "straveler-252fc.firebaseapp.com",
        projectId: "straveler-252fc",
        storageBucket: "straveler-252fc.firebasestorage.app",
        messagingSenderId: "124387208834",
        appId: "1:124387208834:web:871cf13525072ad3310e9b",
        measurementId: "G-C034PW0KPJ"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Donn√©es globales
    let DB = { user: null, pendingApprovals: [], rocks: [] };

    // Image par d√©faut grise (SVG)
    const DEFAULT_IMAGE = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23f3f4f6'/%3E%3Cpath d='M80,70 C80,65.58 83.58,62 88,62 L112,62 C116.42,62 120,65.58 120,70 L120,90 C120,94.42 116.42,98 112,98 L88,98 C83.58,98 80,94.42 80,90 L80,70 Z M70,110 C70,105.58 73.58,102 78,102 L122,102 C126.42,102 130,105.58 130,110 L130,130 C130,134.42 126.42,138 122,138 L78,138 C73.58,138 70,134.42 70,130 L70,110 Z' fill='%239ca3af'/%3E%3C/svg%3E";

    // Application principale
    const app = {
        currentRockId: null,
        currentImageIndex: 0,
        mapInstance: null,
        polylineInstance: null,
        markersInstance: [],
        stepMapInstance: null,
        stepMarker: null,
        createMapInstance: null,
        createMarker: null,
        mobileView: false,
        uploadedImageUrl: null,

        init: function() {
            console.log("Initialisation de l'application...");
            this.detectMobile();
            this.renderNav();
            this.attachAuthListener();
            this.setupFirestoreListeners();
            this.setupMobileBehavior();
            this.setupImageUpload();
        },

        // Upload d'images
        setupImageUpload: function() {
            const uploadArea = document.getElementById('upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });
            }
        },

        handleImageUpload: function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Veuillez s√©lectionner une image valide');
                return;
            }
            
            this.uploadImageToFirebase(file);
        },

        uploadImageToFirebase: function(file) {
            if (!DB.user) {
                alert('Veuillez vous connecter pour uploader une image');
                return;
            }
            
            const uploadArea = document.getElementById('upload-area');
            const previewContainer = document.getElementById('image-preview-container');
            const preview = document.getElementById('image-preview');
            const progress = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-progress-bar');
            
            // Afficher la pr√©visualisation
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                previewContainer.classList.remove('hidden');
                uploadArea.classList.add('hidden');
            };
            reader.readAsDataURL(file);
            
            // Upload vers Firebase Storage
            const filename = `images/${Date.now()}_${file.name}`;
            const uploadTask = storage.ref().child(filename).put(file);
            
            progress.classList.remove('hidden');
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progressValue = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progressValue + '%';
                },
                (error) => {
                    console.error('Upload error:', error);
                    alert('Erreur lors de l\'upload: ' + error.message);
                    progress.classList.add('hidden');
                    this.removeImage();
                },
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        this.uploadedImageUrl = downloadURL;
                        document.getElementById('create-img-input').value = downloadURL;
                        progress.classList.add('hidden');
                    });
                }
            );
        },

        removeImage: function() {
            this.uploadedImageUrl = null;
            document.getElementById('create-img-input').value = '';
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('upload-area').classList.remove('hidden');
            document.getElementById('file-input').value = '';
        },

        // Authentification
        attachAuthListener: function() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        const udoc = await db.collection('users').doc(user.uid).get();
                        if (udoc.exists) {
                            DB.user = { uid: user.uid, ...udoc.data() };
                        } else {
                            const profile = {
                                name: user.displayName || (user.email ? user.email.split('@')[0] : "Anonyme"),
                                email: user.email || null,
                                avatar: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || "Utilisateur")}&background=0D9488&color=fff`,
                                bio: ""
                            };
                            await db.collection('users').doc(user.uid).set(profile);
                            DB.user = { uid: user.uid, ...profile };
                        }
                    } catch (e) {
                        console.error("profile load error", e);
                        DB.user = { uid: user.uid, name: user.email || "Utilisateur", avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email || 'Utilisateur')}&background=0D9488&color=fff` };
                    }
                } else {
                    DB.user = null;
                }
                this.renderNav();
            });
        },

        handleLogin: function(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .then(() => { this.showPage('home'); })
                .catch(err => alert("Erreur connexion : " + err.message));
        },

        handleSignup: function(e) {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then(async cred => {
                    const uid = cred.user.uid;
                    const profile = {
                        name: name,
                        email: email,
                        avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`,
                        bio: "Nouveau membre !"
                    };
                    await db.collection('users').doc(uid).set(profile);
                    this.showPage('home');
                    alert(`Bienvenue ${name}.`);
                })
                .catch(err => alert("Erreur inscription : " + err.message));
        },

        signInWithGoogle: function() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(err => alert("Erreur Google SignIn : " + err.message));
        },

        signInAnonymously: function() {
            auth.signInAnonymously().catch(err => alert("Erreur connexion anonyme : " + err.message));
        },

        logout: function() {
            auth.signOut().then(()=> {
                DB.user = null;
                this.renderNav();
                this.showPage('home');
            });
        },

        // Navigation
        renderNav: function() {
            const nav = document.getElementById('nav-buttons');
            if (DB.user) {
                let notifHTML = '';
                if(DB.pendingApprovals && DB.pendingApprovals.length > 0) {
                    notifHTML = `<div class="relative cursor-pointer mr-2 group"><div class="py-2"><i class="fa-solid fa-bell text-gray-500 text-xl group-hover:text-emerald-600 transition"></i><span class="absolute top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1 rounded-full animate-pulse">${DB.pendingApprovals.length}</span></div></div>`;
                } else { 
                    notifHTML = `<div class="relative mr-2 py-2 text-gray-300 cursor-default"><i class="fa-regular fa-bell text-xl"></i></div>`; 
                }
                nav.innerHTML = `${notifHTML}<div class="flex items-center gap-2 border-l pl-4 border-gray-200"><div onclick="app.showPage('profile')" class="cursor-pointer flex items-center gap-2 hover:bg-gray-50 p-1 rounded-full pr-3 transition"><img src="${DB.user.avatar}" class="w-8 h-8 rounded-full border border-gray-200 object-cover"><span class="text-sm font-medium hidden sm:block text-gray-700">${DB.user.name}</span></div><button onclick="app.logout()" class="text-gray-400 hover:text-red-500 ml-1" title="D√©connexion"><i class="fa-solid fa-sign-out-alt"></i></button></div>`;
            } else {
                nav.innerHTML = `<button onclick="app.showPage('auth')" class="bg-emerald-600 text-white px-4 py-2 rounded-full hover:bg-emerald-700 transition shadow-sm text-sm font-bold flex items-center"><i class="fa-solid fa-user mr-2"></i> Connexion</button>`;
            }
        },

        // Pages
        showPage: function(pg) {
            ['page-home', 'page-ranking', 'page-auth', 'page-profile'].forEach(p => {
                document.getElementById(p).classList.add('hidden');
            });
            document.getElementById('page-' + pg).classList.remove('hidden');
            
            if (pg === 'home') {
                document.getElementById('page-home').classList.add('flex');
                if (this.mobileView) {
                    this.showRockList();
                }
            }
            
            if (pg === 'ranking') this.renderRanking('likes');
            if (pg === 'profile' && DB.user) {
                document.getElementById('edit-name').value = DB.user.name;
                document.getElementById('edit-bio').value = DB.user.bio || "";
                document.getElementById('edit-avatar').value = DB.user.avatar || "";
                document.getElementById('profile-preview-img').src = DB.user.avatar || "";
            }
        },

        toggleAuthMode: function(mode) {
            if (mode === 'signup') {
                document.getElementById('auth-login').classList.add('hidden');
                document.getElementById('auth-signup').classList.remove('hidden');
            } else {
                document.getElementById('auth-signup').classList.add('hidden');
                document.getElementById('auth-login').classList.remove('hidden');
            }
        },

        // Modals
        openModal: function(type) {
            if (!DB.user) {
                alert("Veuillez vous connecter pour acc√©der √† cette fonctionnalit√©.");
                this.showPage('auth');
                return;
            }
            
            const modal = document.getElementById('modal-' + type);
            modal.classList.remove('hidden');
            setTimeout(() => {
                if (type === 'create') {
                    this.initCreateMap();
                } else if (type === 'step') {
                    this.initStepMap();
                }
            }, 100);
        },

        closeModal: function(type) {
            const modal = document.getElementById('modal-' + type);
            modal.classList.add('hidden');
            const form = modal.querySelector('form');
            if (form) form.reset();
            if (type === 'create') {
                this.removeImage();
            }
        },

        // Firestore
        setupFirestoreListeners: function() {
            // √âcoute des pierres
            db.collection('rocks').onSnapshot(snapshot => {
                DB.rocks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                DB.rocks.forEach(r => {
                    r.likes = r.likes || 0;
                    r.likedBy = r.likedBy || [];
                    r.totalKm = r.totalKm || 0;
                    r.borders = r.borders || 0;
                    r.images = r.images && r.images.length ? r.images : [DEFAULT_IMAGE];
                    r.comments = r.comments || [];
                    r.path = r.path || [];
                });
                this.renderRockList();
            });

            // √âcoute des approbations en attente
            db.collection('meta').doc('pendingApprovals').onSnapshot(doc => {
                if (doc.exists) DB.pendingApprovals = doc.data().items || []; 
                else DB.pendingApprovals = [];
                this.renderNav();
            });
        },

        // Pierres
        renderRockList: function(filter = "") {
            const list = document.getElementById('rocks-list');
            list.innerHTML = "";
            const term = (filter || "").toLowerCase();
            const filtered = DB.rocks.filter(r => {
                const name = (r.name || '').toLowerCase();
                const code = (r.code || '').toLowerCase();
                return name.includes(term) || code.includes(term);
            });
            
            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 mt-10 italic text-sm">Aucune pierre trouv√©e.</div>`;
                return;
            }
            
            filtered.forEach(r => {
                const active = this.currentRockId === r.id ? 'border-emerald-500 bg-emerald-50 ring-1 ring-emerald-500' : 'border-gray-100 bg-white hover:bg-gray-50';
                const imageUrl = r.images && r.images.length > 0 ? r.images[0] : DEFAULT_IMAGE;
                
                list.innerHTML += `
                    <div onclick="app.selectRock('${r.id}')" class="stone-card p-3 rounded-xl shadow-sm border cursor-pointer flex gap-3 transition-all ${active}">
                        <div class="relative w-20 h-20 shrink-0">
                            <img src="${imageUrl}" class="w-full h-full rounded-lg object-cover bg-gray-200">
                            <div class="absolute bottom-0 right-0 bg-black/50 text-white text-[10px] px-1 rounded-tl-md">${r.images ? r.images.length : 0} <i class="fa-solid fa-camera"></i></div>
                        </div>
                        <div class="flex-1 min-w-0 flex flex-col justify-center">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-bold text-gray-800 truncate text-sm">${r.name}</h4>
                                <span class="text-[10px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded font-mono border border-emerald-200">${r.code || ''}</span>
                            </div>
                            <div class="text-xs text-gray-500 mb-2 flex items-center gap-1">
                                <i class="fa-solid fa-location-dot text-gray-400"></i> 
                                <span class="truncate">${r.path[0] ? r.path[0].name : 'Inconnu'}</span>
                            </div>
                            <div class="flex items-center justify-between text-xs mt-auto border-t pt-2 border-gray-100">
                                <span class="text-emerald-600 font-semibold"><i class="fa-solid fa-road"></i> ${(r.totalKm || 0).toFixed(1)} km</span>
                                <span class="text-gray-400"><i class="fa-solid fa-heart"></i> ${r.likes || 0}</span>
                            </div>
                        </div>
                    </div>`;
            });
        },

        handleSearch: function() { 
            this.renderRockList(document.getElementById('search-input').value); 
        },

        selectRock: function(id) {
            this.currentRockId = id;
            const r = this.getRock(id);
            if(!r) return;
            
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('details-content').classList.remove('hidden');
            
            // Mettre √† jour les d√©tails
            document.getElementById('detail-name').innerText = r.name;
            document.getElementById('detail-code').innerText = r.code || '';
            document.getElementById('detail-author').innerText = r.author || '';
            document.getElementById('detail-date').innerText = r.createdAt || '';
            document.getElementById('detail-likes').innerText = r.likes || 0;
            document.getElementById('detail-likes-mobile').innerText = r.likes || 0;
            document.getElementById('detail-desc').innerText = r.description || '';
            document.getElementById('detail-km').innerText = (r.totalKm || 0).toFixed(1);
            document.getElementById('detail-borders').innerText = r.borders || 0;
            
            // Mettre √† jour le carousel
            this.currentImageIndex = 0;
            this.updateCarouselUI(r);
            
            if (this.mobileView) {
                this.showRockDetails();
            }
            
            this.renderComments(r);
        },

        getRock: function(id) { 
            return DB.rocks.find(r => r.id === id); 
        },

        // Carousel
        updateCarouselUI: function(r) {
            const img = document.getElementById('carousel-img');
            const cnt = document.getElementById('carousel-counter');
            const imageUrl = r.images && r.images.length > 0 ? r.images[this.currentImageIndex] : DEFAULT_IMAGE;
            
            img.style.opacity = '0.5';
            setTimeout(() => { 
                img.src = imageUrl; 
                img.style.opacity = '1'; 
            }, 100);
            cnt.innerText = `${this.currentImageIndex + 1} / ${r.images.length}`;
        },

        moveCarousel: function(d) {
            const r = this.getRock(this.currentRockId); 
            if(!r) return;
            this.currentImageIndex = (this.currentImageIndex + d + r.images.length) % r.images.length;
            this.updateCarouselUI(r);
        },

        // Classement
        renderRanking: function(crit) {
            const tbody = document.getElementById('ranking-list'); 
            tbody.innerHTML = "";
            const sorted = [...DB.rocks].sort((a, b) => crit === 'likes' ? (b.likes||0) - (a.likes||0) : (b.totalKm||0) - (a.totalKm||0));
            sorted.forEach((r, i) => {
                let m = i === 0 ? "ü•á" : i === 1 ? "ü•à" : i === 2 ? "ü•â" : "";
                const imageUrl = r.images && r.images.length > 0 ? r.images[0] : DEFAULT_IMAGE;
                
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${m} ${i + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <img class="h-10 w-10 rounded-full object-cover mr-3 border" src="${imageUrl}">
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${r.name}</div>
                                    <div class="text-xs text-gray-500">${r.code || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div class="font-bold ${crit === 'km' ? 'text-emerald-600' : ''}">${(r.totalKm || 0).toFixed(1)} km</div>
                            <div class="${crit === 'likes' ? 'text-red-500 font-bold' : ''}">${r.likes || 0} likes</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="app.showPage('home'); app.selectRock('${r.id}')" class="text-emerald-600 hover:text-emerald-900 hover:underline">Voir</button>
                        </td>
                    </tr>`;
            });
        },

        // Commentaires
        renderComments: function(r) {
            const l = document.getElementById('comments-list'); 
            const f = document.getElementById('comment-form-container');
            document.getElementById('comments-count').innerText = (r.comments || []).length;
            l.innerHTML = "";
            const comments = r.comments || [];
            
            if(comments.length === 0) {
                l.innerHTML = `<p class="text-sm text-gray-400 italic text-center py-2">Soyez le premier √† √©crire.</p>`;
            } else {
                comments.forEach(c => {
                    const av = c.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(c.user || 'Anon')}&background=random`;
                    l.innerHTML += `
                        <div class="flex gap-3 group">
                            <img src="${av}" class="w-8 h-8 rounded-full object-cover shadow-sm bg-gray-200">
                            <div class="bg-gray-50 p-3 rounded-2xl rounded-tl-none flex-1 text-sm border border-gray-100 group-hover:border-gray-200 transition">
                                <div class="flex justify-between mb-1 items-baseline">
                                    <span class="font-bold text-gray-700">${c.user}</span>
                                    <span class="text-[10px] text-gray-400 uppercase">${c.date}</span>
                                </div>
                                <p class="text-gray-600 leading-relaxed">${c.text}</p>
                            </div>
                        </div>`;
                });
            }
            
            if(DB.user && DB.user.uid) {
                f.innerHTML = `
                    <form onsubmit="app.postComment(event)" class="flex gap-2 mt-4 relative">
                        <input id="comment-input" type="text" placeholder="√âcrire un commentaire..." class="flex-1 border border-gray-300 rounded-full pl-4 pr-12 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:outline-none shadow-sm">
                        <button type="submit" class="absolute right-1 top-1 bottom-1 bg-emerald-600 text-white w-8 h-8 rounded-full hover:bg-emerald-700 flex items-center justify-center shadow-md transition transform hover:scale-105">
                            <i class="fa-solid fa-paper-plane text-xs"></i>
                        </button>
                    </form>`;
            } else {
                f.innerHTML = `
                    <div class="bg-blue-50 border border-blue-100 p-3 rounded-lg text-sm text-blue-800 text-center cursor-pointer hover:bg-blue-100 transition" onclick="app.showPage('auth')">
                        <i class="fa-solid fa-lock mr-2"></i>Connectez-vous pour commenter.
                    </div>`;
            }
        },

        postComment: function(e) {
            e.preventDefault();
            const i = document.getElementById('comment-input');
            if(!i || !i.value.trim()) return;
            const r = this.getRock(this.currentRockId);
            if (!r) return alert("Pierre non trouv√©e.");
            const newComment = { 
                id: Date.now().toString(),
                user: DB.user ? DB.user.name : "Anonyme", 
                userId: DB.user ? DB.user.uid : null,
                avatar: DB.user ? DB.user.avatar : null, 
                text: i.value.trim(), 
                date: new Date().toLocaleString() 
            };
            db.collection('rocks').doc(r.id).update({
                comments: firebase.firestore.FieldValue.arrayUnion(newComment)
            }).then(() => { i.value = ""; }).catch(err => alert("Erreur commentaire : " + err.message));
        },

        // Mobile
        detectMobile: function() {
            this.mobileView = window.innerWidth <= 768;
        },

        setupMobileBehavior: function() {
            if (this.mobileView) {
                this.showRockList();
            }
        },

        showRockList: function() {
            if (this.mobileView) {
                document.querySelector('.lg\\:col-span-4').classList.remove('hidden');
                document.querySelector('.lg\\:col-span-8').classList.add('hidden');
            }
        },

        showRockDetails: function() {
            if (this.mobileView) {
                document.querySelector('.lg\\:col-span-4').classList.add('hidden');
                document.querySelector('.lg\\:col-span-8').classList.remove('hidden');
            }
        },

        // Cartes (simplifi√© pour √©viter les erreurs)
        initMap: function(r) {
            if(!r || !r.path || r.path.length === 0) return;
            
            if (this.mapInstance) {
                this.mapInstance.remove();
            }
            
            this.mapInstance = L.map('map').setView([r.path[0].lat, r.path[0].lng], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.mapInstance);
            
            // Ajouter les marqueurs
            r.path.forEach((point, i) => {
                L.marker([point.lat, point.lng])
                    .addTo(this.mapInstance)
                    .bindPopup(`<b>${i === 0 ? 'D√©part' : '√âtape ' + i}</b><br>${point.name}`);
            });
        },

        initCreateMap: function() {
            if (this.createMapInstance) {
                this.createMapInstance.remove();
            }
            
            this.createMapInstance = L.map('map-create').setView([46.603354, 1.888334], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.createMapInstance);
            
            this.createMapInstance.on('click', (e) => {
                this.setCreateLocation(e.latlng.lat, e.latlng.lng);
            });
        },

        initStepMap: function() {
            if (this.stepMapInstance) {
                this.stepMapInstance.remove();
            }
            
            this.stepMapInstance = L.map('map-step').setView([46.603354, 1.888334], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.stepMapInstance);
            
            this.stepMapInstance.on('click', (e) => {
                this.setStepLocation(e.latlng.lat, e.latlng.lng);
            });
        },

        setCreateLocation: function(lat, lng) {
            if(this.createMarker) this.createMapInstance.removeLayer(this.createMarker);
            this.createMarker = L.marker([lat, lng]).addTo(this.createMapInstance);
            document.getElementById('create-lat').value = lat; 
            document.getElementById('create-lng').value = lng;
            this.reverseGeocode(lat, lng, 'create-location-name', 'geo-loading-create');
        },

        setStepLocation: function(lat, lng) {
            if(this.stepMarker) this.stepMapInstance.removeLayer(this.stepMarker);
            this.stepMarker = L.marker([lat, lng]).addTo(this.stepMapInstance);
            document.getElementById('step-lat').value = lat; 
            document.getElementById('step-lng').value = lng;
            this.reverseGeocode(lat, lng, 'step-location-name', 'geo-loading');
        },

        reverseGeocode: function(lat, lng, inputId, loaderId) {
            const input = document.getElementById(inputId); 
            input.value = `${lat.toFixed(4)}, ${lng.toFixed(4)}...`;
            const loader = document.getElementById(loaderId);
            if (loader) loader.classList.remove('hidden');
            
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(res => res.json())
            .then(data => {
                const city = data.address?.city || data.address?.town || data.address?.village || data.address?.hamlet || "Lieu";
                const country = data.address?.country || "";
                input.value = `${city}, ${country}`;
            })
            .catch(() => {
                input.value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            })
            .finally(() => { 
                if (loader) loader.classList.add('hidden'); 
            });
        },

        locateUser: function(type) {
            if(!navigator.geolocation) { alert("Non support√©"); return; }
            navigator.geolocation.getCurrentPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                if(type === 'create') { 
                    this.createMapInstance.setView([latitude, longitude], 13); 
                    this.setCreateLocation(latitude, longitude); 
                }
                else { 
                    this.stepMapInstance.setView([latitude, longitude], 13); 
                    this.setStepLocation(latitude, longitude); 
                }
            }, () => { alert("Erreur GPS"); });
        },

        // Cr√©ation de pierre
        handleCreateStone: function(e) {
            e.preventDefault();
            const lat = document.getElementById('create-lat').value;
            const lng = document.getElementById('create-lng').value;
            const name = document.getElementById('create-name-input').value;
            const desc = document.getElementById('create-desc-input').value;
            
            let imgUrl = this.uploadedImageUrl || DEFAULT_IMAGE;
            
            const location = document.getElementById('create-location-name').value;
        
            if(!lat || !lng) { alert("Placez un point sur la carte !"); return; }
            if(!DB.user || !DB.user.uid) { alert("Connectez-vous pour cr√©er une pierre."); return; }
        
            const newRock = {
                code: "ST-" + Math.floor(Math.random() * 100000),
                name: name,
                author: DB.user.name || DB.user.email || "Anonyme",
                authorId: DB.user.uid,
                createdAt: new Date().toISOString().split('T')[0],
                description: desc,
                likes: 0,
                likedBy: [],
                totalKm: 0,
                borders: 0,
                images: [imgUrl],
                path: [{ 
                    lat: parseFloat(lat), 
                    lng: parseFloat(lng), 
                    name: location 
                }],
                comments: []
            };
        
            db.collection('rocks').add(newRock).then(ref => {
                this.closeModal('create');
                alert("Pierre cr√©√©e : " + newRock.code);
                this.uploadedImageUrl = null;
            }).catch(err => alert("Erreur cr√©ation pierre : " + err.message));
        },

        // Gestion des √©tapes
        handleStep: function(e) {
            e.preventDefault();
            const lat = document.getElementById('step-lat').value;
            const lng = document.getElementById('step-lng').value;
            const code = document.getElementById('step-code-input').value.trim();
            const message = document.getElementById('step-message-input').value.trim();
            
            if (!lat || !lng) return alert("Cliquez sur la carte !");
            if (!code) return alert("Code de la pierre requis.");

            const rock = DB.rocks.find(r => (r.code||'').toLowerCase() === code.toLowerCase());
            if (!rock) return alert("Pierre introuvable avec ce code.");

            const metaRef = db.collection('meta').doc('pendingApprovals');
            metaRef.get().then(d => {
                let items = [];
                if (d.exists) items = d.data().items || [];
                const pend = {
                    id: Date.now().toString(),
                    rockId: rock.id,
                    rockCode: rock.code,
                    rockName: rock.name,
                    location: document.getElementById('step-location-name').value || '',
                    kmToAdd: 0,
                    lat: parseFloat(lat),
                    lng: parseFloat(lng),
                    message: message,
                    by: DB.user ? (DB.user.name || DB.user.email) : 'Anonyme',
                    at: new Date().toISOString()
                };
                items.unshift(pend);
                metaRef.set({ items: items }).then(() => {
                    alert("√âtape envoy√©e (en attente d'approbation).");
                    this.closeModal('step');
                }).catch(err => alert("Erreur envoi √©tape : " + err.message));
            }).catch(err => alert("Erreur meta read : " + err.message));
        },

        // Likes
        toggleLike: function() {
            const r = this.getRock(this.currentRockId);
            if(!r || !DB.user) return;
            
            const userLiked = r.likedBy && r.likedBy.includes(DB.user.uid);
            const newLikes = userLiked ? (r.likes - 1) : (r.likes + 1);
            const newLikedBy = userLiked ? 
                (r.likedBy || []).filter(uid => uid !== DB.user.uid) : 
                [...(r.likedBy || []), DB.user.uid];
            
            db.collection('rocks').doc(r.id).update({
                likes: newLikes,
                likedBy: newLikedBy
            }).catch(err => console.error("Like error:", err));
        },

        // Gestion du profil
        handleUpdateProfile: async function(e) {
            e.preventDefault();
            if (!DB.user || !DB.user.uid) return alert("Aucun utilisateur connect√©.");
            try {
                const updatedData = {
                    name: document.getElementById('edit-name').value,
                    bio: document.getElementById('edit-bio').value
                };
                const avatar = document.getElementById('edit-avatar').value;
                if (avatar) updatedData.avatar = avatar;
                
                await db.collection('users').doc(DB.user.uid).update(updatedData);
                DB.user = { ...DB.user, ...updatedData };
                alert("Profil mis √† jour !");
                this.renderNav();
            } catch (e) {
                alert("Erreur mise √† jour profil : " + e.message);
            }
        }
    };

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        app.init();
    });

    </script>
</body>
</html>
